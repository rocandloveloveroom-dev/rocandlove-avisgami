<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roc & Love - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="./assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face{font-family:'Brittany Signature';src:url('./assets/BrittanySignature.ttf') format('truetype')}
        .brittany{font-family:'Brittany Signature',cursive}.georgia{font-family:Georgia,serif}.cormorant{font-family:'Cormorant Garamond',serif}
        .blur-bubble{position:fixed;width:24rem;height:24rem;border-radius:50%;filter:blur(80px);opacity:.2;pointer-events:none}
        .stat-card{background:linear-gradient(135deg,rgba(185,163,120,.1) 0%,rgba(139,115,85,.1) 100%);border:1px solid rgba(185,163,120,.3);border-radius:1rem;padding:1.5rem;transition:all .3s}
        .stat-card:hover{border-color:rgba(185,163,120,.6);transform:translateY(-2px)}
        .code-badge{display:inline-block;padding:.25rem .75rem;border-radius:.5rem;font-family:'Courier New',monospace;font-weight:700;font-size:.875rem}
        .code-ROCLOVE10{background:rgba(96,165,250,.2);color:#60a5fa}.code-ROCLOVE15{background:rgba(139,92,246,.2);color:#8b5cf6}
        .code-ROCLOVEVV{background:rgba(251,146,60,.2);color:#fb923c}.code-ROCLOVELB{background:rgba(236,72,153,.2);color:#ec4899}
        .channel-badge{display:inline-block;padding:.25rem .75rem;border-radius:.5rem;font-size:.75rem;font-weight:600}
        .channel-booking{background:rgba(0,108,228,.2);color:#006CE4}.channel-airbnb{background:rgba(255,90,95,.2);color:#FF5A5F}.channel-direct{background:rgba(185,163,120,.2);color:#B9A378}
        .input-field{width:100%;padding:12px;border:2px solid #B9A378;border-radius:8px;background:rgba(255,255,255,.05);color:#fff;font-family:Georgia,serif}
        .input-field:focus{outline:0;border-color:#DCD1BC;background:rgba(255,255,255,.1)}
        select.input-field{cursor:pointer}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:9999}
        .hidden{display:none!important}
        table{width:100%;border-collapse:collapse}
        th{background:rgba(185,163,120,.1);padding:12px;text-align:left;font-weight:600;border-bottom:2px solid rgba(185,163,120,.3)}
        td{padding:12px;border-bottom:1px solid rgba(185,163,120,.1)}
        tr:hover{background:rgba(185,163,120,.05)}
        .tab-button{padding:.75rem 1.5rem;border-radius:.5rem;transition:all .3s;cursor:pointer}
        .tab-button.active{background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%);color:#000}
        .tab-button:not(.active){color:#B9A378;border:1px solid rgba(185,163,120,.3)}
        .tab-button:not(.active):hover{background:rgba(185,163,120,.1)}
        #qrcodeCanvas{margin:0 auto;border:4px solid #B9A378;border-radius:1rem;padding:1rem;background:#fff}
        .refresh-btn{animation:fadeIn 0.3s ease-in}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div class="blur-bubble bg-yellow-900 top-0 left-0"></div>
    <div class="blur-bubble bg-yellow-900 bottom-0 right-0"></div>
    
    <div class="relative z-10 container mx-auto px-4 py-8 max-w-7xl">
        <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl mb-8">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="brittany text-4xl sm:text-5xl mb-2" style="color:#B9A378">Dashboard Admin</h1>
                    <p class="georgia text-gray-400">Gestion multi-canal de la gamification</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshData()" class="cormorant py-2 px-4 rounded-lg font-bold text-sm border-2 border-yellow-700 text-white transition-all duration-300 hover:bg-yellow-900/20" title="Actualiser les donn√©es">üîÑ Actualiser</button>
                    <button onclick="showPasswordModal()" class="cormorant py-2 px-4 rounded-lg font-bold text-sm border-2 border-yellow-700 text-white transition-all duration-300 hover:bg-yellow-900/20">üîí Mot de passe</button>
                    <button onclick="exportData()" class="cormorant py-2 px-4 rounded-lg font-bold text-sm text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">üì• Export CSV</button>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3 mb-8 flex-wrap">
            <button onclick="showTab('generator')" id="tab-generator" class="tab-button active cormorant font-bold">ü™Ñ G√©n√©rateur</button>
            <button onclick="showTab('stats')" id="tab-stats" class="tab-button cormorant font-bold">üìä Stats</button>
            <button onclick="showTab('prizes')" id="tab-prizes" class="tab-button cormorant font-bold">üéÅ Lots</button>
            <button onclick="showTab('history')" id="tab-history" class="tab-button cormorant font-bold">üìã Historique</button>
            <button onclick="showTab('config')" id="tab-config" class="tab-button cormorant font-bold">‚öôÔ∏è Config</button>
        </div>
        
        <div id="content-generator" class="tab-content">
            <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl">
                <h2 class="brittany text-3xl mb-6 text-center" style="color:#B9A378">ü™Ñ G√©n√©rateur de Liens Personnalis√©s</h2>
                <div class="max-w-2xl mx-auto">
                    <div class="bg-yellow-900/20 border border-yellow-700/30 rounded-xl p-6 mb-8">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div><label class="georgia text-sm text-gray-400 mb-2 block">Pr√©nom du client</label><input type="text" id="genName" class="input-field" placeholder="Marie"/></div>
                            <div><label class="georgia text-sm text-gray-400 mb-2 block">T√©l√©phone (optionnel)</label><input type="tel" id="genPhone" class="input-field" placeholder="0612345678"/></div>
                            <div><label class="georgia text-sm text-gray-400 mb-2 block">Email du client</label><input type="text" id="genEmail" class="input-field" placeholder="client@exemple.com"/></div>
                        </div>
                        <div class="mb-6">
                            <label class="georgia text-sm text-gray-400 mb-2 block">Plateforme de r√©servation</label>
                            <select id="genChannel" class="input-field">
                                <option value="direct">‚≠ê Direct (Google)</option>
                                <option value="booking">üè® Booking.com</option>
                                <option value="airbnb">üè† Airbnb</option>
                            </select>
                        </div>
                        <button onclick="generateLink()" class="cormorant w-full py-4 px-6 rounded-xl font-bold text-xl text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">ü™Ñ G√©n√©rer le lien et le QR Code</button>
                    </div>
                    <div id="generatedResult" class="hidden">
                        <div class="bg-gradient-to-br from-gray-900 to-black border-2 border-yellow-700 rounded-2xl p-6 mb-6">
                            <h3 class="georgia font-bold text-xl mb-4 text-center" style="color:#B9A378">üì± Lien Personnalis√©</h3>
                            <div class="bg-black/30 rounded-xl p-4 mb-4">
                                <p class="text-sm text-gray-400 mb-2">Lien complet :</p>
                                <div class="flex gap-2">
                                    <input type="text" id="generatedLink" class="input-field text-sm" readonly/>
                                    <button onclick="copyGeneratedLink()" class="cormorant py-2 px-4 rounded-lg font-bold text-sm text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">üìã</button>
                                </div>
                            </div>
                            <div class="bg-yellow-900/20 border border-yellow-700/30 rounded-xl p-4">
                                <p class="georgia text-sm text-center text-gray-300 mb-3">üí° Envoyez ce lien par SMS au client</p>
                                <p class="georgia text-xs text-center text-gray-500">Le bouton d'avis s'adaptera automatiquement √† la plateforme choisie</p>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-gray-900 to-black border-2 border-yellow-700 rounded-2xl p-6">
                            <h3 class="georgia font-bold text-xl mb-4 text-center" style="color:#B9A378">üì∏ QR Code</h3>
                            <div class="flex justify-center mb-4"><div id="qrcodeCanvas"></div></div>
                            <div class="flex gap-3">
                                <button onclick="downloadQRCode()" class="cormorant flex-1 py-3 px-6 rounded-xl font-bold text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">üì• T√©l√©charger</button>
                                <button onclick="printQRCode()" class="cormorant flex-1 py-3 px-6 rounded-xl font-bold border-2 border-yellow-700 text-white transition-all duration-300 hover:bg-yellow-900/20">üñ®Ô∏è Imprimer</button>
                            </div>
                            <p class="georgia text-xs text-center text-gray-500 mt-4">üí° Imprimez et laissez le QR Code dans la chambre !</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="content-stats" class="tab-content hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="stat-card"><div class="text-gray-400 text-sm mb-1">Total participations</div><div class="text-3xl font-bold" style="color:#B9A378" id="totalParticipations">0</div></div>
                <div class="stat-card"><div class="text-gray-400 text-sm mb-1">Avis cliqu√©s</div><div class="text-3xl font-bold" style="color:#B9A378" id="totalReviews">0</div></div>
                <div class="stat-card"><div class="text-gray-400 text-sm mb-1">Taux de conversion</div><div class="text-3xl font-bold" style="color:#B9A378" id="conversionRate">0%</div></div>
                <div class="stat-card"><div class="text-gray-400 text-sm mb-1">Codes utilis√©s</div><div class="text-3xl font-bold" style="color:#B9A378" id="codesUsed">0</div></div>
            </div>
            <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl mb-8">
                <h2 class="brittany text-3xl mb-6" style="color:#B9A378">Statistiques par canal</h2>
                <div id="channelStats" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
            </div>
            <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl">
                <h2 class="brittany text-3xl mb-6" style="color:#B9A378">Distribution des codes</h2>
                <div id="prizesStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </div>
        </div>
        
        <div id="content-prizes" class="tab-content hidden">
            <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="brittany text-3xl" style="color:#B9A378">Configuration des lots</h2>
                    <button onclick="showAddPrizeModal()" class="cormorant py-2 px-4 rounded-lg font-bold text-sm text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">‚ûï Ajouter un lot</button>
                </div>
                <div id="prizesList" class="space-y-4"></div>
            </div>
        </div>
        
        <div id="content-history" class="tab-content hidden">
            <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl">
                <h2 class="brittany text-3xl mb-6" style="color:#B9A378">Historique des participations</h2>
                <div class="overflow-x-auto">
                    <table class="georgia text-sm">
                        <thead><tr><th>Date</th><th>Client</th><th>T√©l√©phone</th><th>Canal</th><th>Lot</th><th>Code</th><th>Avis</th><th>Notes</th><th></th></tr></thead>
                        <tbody id="historyTable"><tr><td colspan="9" class="text-center text-gray-500 py-8">Aucune participation</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="content-config" class="tab-content hidden">
            <div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-6 sm:p-8 shadow-2xl">
                <h2 class="brittany text-3xl mb-6" style="color:#B9A378">Configuration des liens d'avis</h2>
                <div class="space-y-6">
                    <div><label class="georgia text-sm text-gray-400 mb-2 block flex items-center gap-2"><span class="text-2xl">üè®</span> Lien Booking.com</label><input type="url" id="bookingUrl" class="input-field" placeholder="https://www.booking.com/reviewlist.html?pagename=..."/><p class="text-xs text-gray-500 mt-2">Lien vers votre page d'avis Booking</p></div>
                    <div><label class="georgia text-sm text-gray-400 mb-2 block flex items-center gap-2"><span class="text-2xl">üè†</span> Lien Airbnb</label><input type="url" id="airbnbUrl" class="input-field" placeholder="https://www.airbnb.fr/rooms/..."/><p class="text-xs text-gray-500 mt-2">Lien vers votre logement Airbnb</p></div>
                    <div><label class="georgia text-sm text-gray-400 mb-2 block flex items-center gap-2"><span class="text-2xl">‚≠ê</span> Lien Google Reviews</label><input type="url" id="googleUrl" class="input-field" placeholder="https://g.page/r/..."/><p class="text-xs text-gray-500 mt-2">Lien vers votre page Google My Business</p></div>
                    <div><label class="georgia text-sm text-gray-400 mb-2 block flex items-center gap-2"><span class="text-2xl">üåê</span> URL de votre site</label><input type="url" id="siteUrl" class="input-field" value="https://gami.rocandlove.fr" readonly/><p class="text-xs text-gray-500 mt-2">URL compl√®te de votre site (pour le g√©n√©rateur de liens)</p></div>
                </div>
                <button onclick="saveConfig()" class="cormorant w-full mt-6 py-3 px-6 rounded-xl font-bold text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">üíæ Sauvegarder la configuration</button>
            </div>
        </div>
    </div>
    
    <div id="passwordModal" class="modal-overlay hidden" onclick="closePasswordModal(event)"><div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()"><h3 class="brittany text-3xl text-center mb-6" style="color:#B9A378">Gestion du mot de passe</h3><div class="mb-6"><label class="georgia text-sm text-gray-400 mb-2 block">Mot de passe actuel</label><div class="flex gap-2"><input type="password" id="currentPasswordDisplay" class="input-field" readonly value="********"/><button onclick="togglePasswordVisibility()" class="cormorant py-2 px-4 rounded-lg font-bold text-sm border-2 border-yellow-700 text-white transition-all duration-300 hover:bg-yellow-900/20">üëÅÔ∏è</button></div></div><div class="mb-6"><label class="georgia text-sm text-gray-400 mb-2 block">Nouveau mot de passe</label><input type="password" id="newPassword" class="input-field" placeholder="Entrez le nouveau mot de passe"/></div><div class="mb-6"><label class="georgia text-sm text-gray-400 mb-2 block">Confirmer</label><input type="password" id="confirmPassword" class="input-field" placeholder="Confirmez"/></div><button onclick="changePassword()" class="cormorant w-full py-3 px-6 rounded-xl font-bold text-black transition-all duration-300 hover:scale-105 mb-3" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">Changer</button><button onclick="closePasswordModal()" class="cormorant w-full py-3 px-6 rounded-xl font-bold border-2 border-yellow-700 text-white transition-all duration-300 hover:bg-yellow-900/20">Annuler</button><p id="passwordMessage" class="text-sm text-center mt-3 hidden"></p></div></div>
    
    <div id="prizeModal" class="modal-overlay hidden" onclick="closePrizeModal(event)"><div class="bg-gradient-to-br from-gray-900 to-black border border-yellow-900/30 rounded-2xl p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()"><h3 class="brittany text-3xl text-center mb-6" style="color:#B9A378" id="prizeModalTitle">Ajouter un lot</h3><div class="mb-4"><label class="georgia text-sm text-gray-400 mb-2 block">Emoji</label><input type="text" id="prizeEmoji" class="input-field text-center text-2xl" placeholder="üéÅ" maxlength="2"/></div><div class="mb-4"><label class="georgia text-sm text-gray-400 mb-2 block">Titre</label><input type="text" id="prizeTitle" class="input-field" placeholder="Bouteille offerte"/></div><div class="mb-4"><label class="georgia text-sm text-gray-400 mb-2 block">Description</label><input type="text" id="prizeDescription" class="input-field" placeholder="lors de votre prochaine r√©servation"/></div><div class="mb-4"><label class="georgia text-sm text-gray-400 mb-2 block">Code promo</label><input type="text" id="prizeCode" class="input-field" placeholder="ROCLOVEXX"/></div><div class="mb-6"><label class="georgia text-sm text-gray-400 mb-2 block">Probabilit√© (%)</label><input type="number" id="prizeProbability" class="input-field" placeholder="30" min="0" max="100"/><p class="text-xs text-gray-500 mt-1">Total = 100%</p></div><button onclick="savePrize()" class="cormorant w-full py-3 px-6 rounded-xl font-bold text-black transition-all duration-300 hover:scale-105 mb-3" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">üíæ Sauvegarder</button><button onclick="closePrizeModal()" class="cormorant w-full py-3 px-6 rounded-xl font-bold border-2 border-yellow-700 text-white transition-all duration-300 hover:bg-yellow-900/20">Annuler</button></div></div>
    
    <script>
        let adminData=[],isPasswordVisible=!1,prizes=[],editingPrizeId=null,currentQRCode=null;
        
        // ‚úÖ FONCTION DE CHARGEMENT DES DONN√âES
        async function loadData(){
            await loadFromNeon();
            prizes=JSON.parse(localStorage.getItem('rocLovePrizes')||'[]');
            if(0===prizes.length){
                prizes=[
                    {id:1,title:'10% de r√©duction',description:'sur votre prochaine r√©servation',emoji:'üé´',probability:15,code:'ROCLOVE10'},
                    {id:2,title:'15% de r√©duction',description:'sur votre prochaine r√©servation',emoji:'üéüÔ∏è',probability:5,code:'ROCLOVE15'},
                    {id:3,title:'Bouteille de Vouvray offerte',description:'lors de votre prochaine r√©servation',emoji:'üçæ',probability:50,code:'ROCLOVEVV'},
                    {id:4,title:'Love Box offerte',description:'lors de votre prochaine r√©servation',emoji:'üíù',probability:30,code:'ROCLOVELB'}
                ];
                savePrizes()
            }
            updateStatistics();
            updateChannelStats();
            updateHistory();
            updatePrizesStats();
            updatePrizesList();
            loadConfig()
        }
        
        // ‚úÖ NOUVEAU BOUTON ACTUALISER MANUEL
        async function refreshData(){
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Chargement...';
            btn.disabled = true;
            
            await loadData();
            
            btn.innerHTML = '‚úÖ √Ä jour !';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1500);
        }
        
        async function loadFromNeon(){
            try{
                const response=await fetch('/api/get-participations');
                if(!response.ok){
                    console.error('Erreur chargement');
                    adminData=[];
                    return
                }
                const data=await response.json();
                if(data.success&&data.participations){
                    adminData=data.participations.map(p=>({
                        sessionId:p.session_id,
                        clientName:p.client_name,
                        clientPhone:p.client_phone,
                        prize:{emoji:p.prize_emoji,title:p.prize_title,description:p.prize_description},
                        code:p.promo_code,
                        date:p.created_at,
                        reviewClicked:p.review_clicked,
                        scratched:p.scratched,
                        channel:p.channel,
                        notes:p.notes||''
                    }))
                }
            }catch(error){
                console.error('Erreur API:',error);
                adminData=[]
            }
        }
        
        function savePrizes(){localStorage.setItem('rocLovePrizes',JSON.stringify(prizes))}
                
        function copyGeneratedLink(){
            const link=document.getElementById('generatedLink').value;
            navigator.clipboard.writeText(link);
            const button=event.target,originalText=button.textContent;
            button.textContent='‚úì';
            setTimeout(()=>{button.textContent=originalText},2000)
        }
        
        function downloadQRCode(){
            if(!currentQRCode)return;
            const link=document.createElement('a');
            link.download=`qrcode-${document.getElementById('genName').value}.png`;
            link.href=currentQRCode.toDataURL();
            link.click()
        }
        
        function printQRCode(){
            if(!currentQRCode)return;
            const win=window.open('','_blank');
            win.document.write('<html><head><title>QR Code</title></head><body style="text-align:center">');
            win.document.write('<h2>Roc & Love - QR Code</h2>');
            win.document.write('<p>'+document.getElementById('genName').value+'</p>');
            win.document.write('<img src="'+currentQRCode.toDataURL()+'"/>');
            win.document.write('</body></html>');
            win.document.close();
            win.print()
        }
        
        function updateStatistics(){
            const total=adminData.length,
                  reviewsClicked=adminData.filter(d=>d.reviewClicked).length,
                  conversionRate=total>0?((reviewsClicked/total)*100).toFixed(1):0;
            document.getElementById('totalParticipations').textContent=total;
            document.getElementById('totalReviews').textContent=reviewsClicked;
            document.getElementById('conversionRate').textContent=conversionRate+'%';
            document.getElementById('codesUsed').textContent='0'
        }
        
        function updateChannelStats(){
            const channels={
                booking:{name:'Booking',icon:'üè®',count:0,reviews:0},
                airbnb:{name:'Airbnb',icon:'üè†',count:0,reviews:0},
                direct:{name:'Direct',icon:'‚≠ê',count:0,reviews:0}
            };
            adminData.forEach(d=>{
                const channel=d.channel||'direct';
                if(channels[channel]){
                    channels[channel].count++;
                    if(d.reviewClicked)channels[channel].reviews++
                }
            });
            const html=Object.entries(channels).map(([key,data])=>{
                const rate=data.count>0?((data.reviews/data.count)*100).toFixed(0):0;
                return`<div class="stat-card"><div class="text-4xl mb-2">${data.icon}</div><div class="text-sm text-gray-400 mb-1">${data.name}</div><div class="text-2xl font-bold mb-1" style="color:#B9A378">${data.count}</div><div class="text-xs text-gray-500">${data.reviews} avis (${rate}%)</div></div>`
            }).join('');
            document.getElementById('channelStats').innerHTML=html
        }
        
        function updatePrizesStats(){
            const codeCounts={};
            prizes.forEach(p=>{codeCounts[p.code]=0});
            adminData.forEach(d=>{if(d.code&&codeCounts.hasOwnProperty(d.code))codeCounts[d.code]++});
            const html=prizes.map(prize=>`<div class="stat-card"><div class="flex items-center justify-between mb-2"><span class="text-4xl">${prize.emoji}</span><span class="code-badge code-${prize.code}">${prize.code}</span></div><div class="text-sm text-gray-400 mb-1">${prize.title}</div><div class="text-2xl font-bold" style="color:#B9A378">${codeCounts[prize.code]||0}</div><div class="text-xs text-gray-500 mt-1">Proba: ${prize.probability}%</div></div>`).join('');
            document.getElementById('prizesStats').innerHTML=html
        }
        
        function updatePrizesList(){
            const totalProba=prizes.reduce((sum,p)=>sum+p.probability,0),
                  warningClass=100!==totalProba?'border-red-500':'',
                  html=prizes.map(prize=>`<div class="stat-card ${warningClass}"><div class="flex items-center justify-between"><div class="flex items-center gap-4 flex-1"><span class="text-5xl">${prize.emoji}</span><div class="flex-1"><h3 class="text-xl font-bold" style="color:#B9A378">${prize.title}</h3><p class="text-sm text-gray-400">${prize.description}</p><div class="flex items-center gap-3 mt-2"><span class="code-badge code-${prize.code}">${prize.code}</span><span class="text-sm text-gray-500">Proba: ${prize.probability}%</span></div></div></div><div class="flex gap-2"><button onclick="editPrize(${prize.id})" class="cormorant py-2 px-4 rounded-lg font-bold text-sm text-black transition-all duration-300 hover:scale-105" style="background:linear-gradient(135deg,#B9A378 0%,#8B7355 100%)">‚úèÔ∏è</button><button onclick="deletePrize(${prize.id})" class="cormorant py-2 px-4 rounded-lg font-bold text-sm border-2 border-red-500 text-red-400 transition-all duration-300 hover:bg-red-900/20">üóëÔ∏è</button></div></div></div>`).join(''),
                  warning=100!==totalProba?`<div class="bg-red-900/20 border border-red-500 rounded-xl p-4 mb-4"><p class="text-red-400 text-center">‚ö†Ô∏è Total = ${totalProba}% (doit √™tre 100%)</p></div>`:'';
            document.getElementById('prizesList').innerHTML=warning+html
        }
        
        function getChannelBadge(channel){
            const channels={
                booking:{class:'channel-booking',text:'üè® Booking'},
                airbnb:{class:'channel-airbnb',text:'üè† Airbnb'},
                direct:{class:'channel-direct',text:'‚≠ê Direct'}
            },ch=channels[channel]||channels.direct;
            return`<span class="channel-badge ${ch.class}">${ch.text}</span>`
        }
        
        function updateHistory(){
            const tbody=document.getElementById('historyTable');
            if(0===adminData.length){
                tbody.innerHTML='<tr><td colspan="9" class="text-center text-gray-500 py-8">Aucune participation</td></tr>';
                return
            }
            const sortedData=[...adminData].sort((a,b)=>new Date(b.date)-new Date(a.date));
            tbody.innerHTML=sortedData.map((item,index)=>{
                const date=new Date(item.date),
                      dateStr=date.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}),
                      clientName=item.clientName||'Non renseign√©',
                      clientPhone=item.clientPhone||'Non renseign√©',
                      channel=item.channel||'direct',
                      prizeTitle=item.prize?.title||'Inconnu',
                      prizeEmoji=item.prize?.emoji||'üéÅ',
                      code=item.code||'N/A',
                      reviewIcon=item.reviewClicked?'‚úÖ':'‚ùå',
                      notes=item.notes||'';
                return`<tr><td>${dateStr}</td><td class="font-semibold">${clientName}</td><td><a href="tel:${clientPhone}" class="text-yellow-700 hover:text-yellow-500">${clientPhone}</a></td><td>${getChannelBadge(channel)}</td><td>${prizeEmoji} ${prizeTitle}</td><td><span class="code-badge code-${code}">${code}</span></td><td class="text-center">${reviewIcon}</td><td><input type="text" value="${notes}" onchange="saveNote('${item.sessionId}', this.value)" placeholder="Notes..." class="w-full px-2 py-1 bg-gray-800 border border-gray-700 rounded text-sm"/></td><td><button onclick="deleteEntry('${item.sessionId}')" class="text-red-400 hover:text-red-300 text-xs">üóëÔ∏è</button></td></tr>`
            }).join('')
        }
        
        // ‚úÖ NOUVELLE FONCTION SAVE NOTE (avec sessionId)
        async function saveNote(sessionId, note){
            // TODO: Cr√©er API pour sauvegarder les notes dans Neon
            // Pour l'instant, on garde juste en local
            const item = adminData.find(d => d.sessionId === sessionId);
            if(item) item.notes = note;
        }
        
        // ‚úÖ NOUVELLE FONCTION DELETE (supprime dans Neon!)
        async function deleteEntry(sessionId){
            if(!confirm('Supprimer cette participation ?')) return;
            
            try {
                const response = await fetch('/api/delete-participation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionId })
                });
                
                if(!response.ok) {
                    alert('‚ùå Erreur lors de la suppression');
                    return;
                }
                
                // Recharger les donn√©es apr√®s suppression
                await loadData();
                
            } catch(error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur de connexion');
            }
        }
        
        function exportData(){
            if(0===adminData.length){alert('Aucune donn√©e');return}
            const headers=['Date','Nom','T√©l√©phone','Canal','Lot','Code','Avis','Notes'],
                  rows=adminData.map(item=>{
                      const date=new Date(item.date).toLocaleString('fr-FR'),
                            name=item.clientName||'Non renseign√©',
                            phone=item.clientPhone||'Non renseign√©',
                            channel=item.channel||'direct',
                            prize=item.prize?.title||'Inconnu',
                            code=item.code||'N/A',
                            review=item.reviewClicked?'Oui':'Non',
                            notes=item.notes||'';
                      return[date,name,phone,channel,prize,code,review,notes]
                  }),
                  csvContent=[headers.join(','),...rows.map(row=>row.map(cell=>`"${cell}"`).join(','))].join('\n'),
                  blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'}),
                  link=document.createElement('a'),
                  url=URL.createObjectURL(blob);
            link.setAttribute('href',url);
            link.setAttribute('download',`roc-love-export-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility='hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link)
        }
        
        function showTab(tabName){
            document.querySelectorAll('.tab-content').forEach(el=>el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el=>el.classList.remove('active'));
            document.getElementById('content-'+tabName).classList.remove('hidden');
            document.getElementById('tab-'+tabName).classList.add('active')
        }
        
        function showPasswordModal(){
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('currentPasswordDisplay').value='********';
            isPasswordVisible=!1
        }
        
        function closePasswordModal(event){
            if(event&&event.target!==event.currentTarget)return;
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('newPassword').value='';
            document.getElementById('confirmPassword').value='';
            document.getElementById('passwordMessage').classList.add('hidden')
        }
        
        function togglePasswordVisibility(){
            const currentPassword=localStorage.getItem('rocLoveAdminPassword')||'RocLove2025',
                  input=document.getElementById('currentPasswordDisplay');
            if(isPasswordVisible){
                input.value='********';
                isPasswordVisible=!1
            }else{
                input.value=currentPassword;
                isPasswordVisible=!0
            }
        }
        
        function changePassword(){
            const newPassword=document.getElementById('newPassword').value,
                  confirmPassword=document.getElementById('confirmPassword').value,
                  messageEl=document.getElementById('passwordMessage');
            if(!newPassword||!confirmPassword){
                messageEl.textContent='Remplir tous les champs';
                messageEl.className='text-red-400 text-sm text-center mt-3';
                messageEl.classList.remove('hidden');
                return
            }
            if(newPassword!==confirmPassword){
                messageEl.textContent='Pas identiques';
                messageEl.className='text-red-400 text-sm text-center mt-3';
                messageEl.classList.remove('hidden');
                return
            }
            if(6>newPassword.length){
                messageEl.textContent='Min 6 caract√®res';
                messageEl.className='text-red-400 text-sm text-center mt-3';
                messageEl.classList.remove('hidden');
                return
            }
            localStorage.setItem('rocLoveAdminPassword',newPassword);
            messageEl.textContent='‚úì Chang√© !';
            messageEl.className='text-green-400 text-sm text-center mt-3';
            messageEl.classList.remove('hidden');
            setTimeout(()=>{closePasswordModal()},2000)
        }
        
        function showAddPrizeModal(){
            editingPrizeId=null;
            document.getElementById('prizeModalTitle').textContent='Ajouter un lot';
            document.getElementById('prizeEmoji').value='';
            document.getElementById('prizeTitle').value='';
            document.getElementById('prizeDescription').value='';
            document.getElementById('prizeCode').value='';
            document.getElementById('prizeProbability').value='';
            document.getElementById('prizeModal').classList.remove('hidden')
        }
        
        function editPrize(id){
            const prize=prizes.find(p=>p.id===id);
            if(!prize)return;
            editingPrizeId=id;
            document.getElementById('prizeModalTitle').textContent='Modifier';
            document.getElementById('prizeEmoji').value=prize.emoji;
            document.getElementById('prizeTitle').value=prize.title;
            document.getElementById('prizeDescription').value=prize.description;
            document.getElementById('prizeCode').value=prize.code;
            document.getElementById('prizeProbability').value=prize.probability;
            document.getElementById('prizeModal').classList.remove('hidden')
        }
        
        function closePrizeModal(event){
            if(event&&event.target!==event.currentTarget)return;
            document.getElementById('prizeModal').classList.add('hidden')
        }
        
        function savePrize(){
            const emoji=document.getElementById('prizeEmoji').value.trim(),
                  title=document.getElementById('prizeTitle').value.trim(),
                  description=document.getElementById('prizeDescription').value.trim(),
                  code=document.getElementById('prizeCode').value.trim().toUpperCase(),
                  probability=parseInt(document.getElementById('prizeProbability').value);
            if(!emoji||!title||!description||!code||!probability){alert('Remplir tous les champs');return}
            if(0>probability||100<probability){alert('0-100');return}
            if(editingPrizeId){
                const index=prizes.findIndex(p=>p.id===editingPrizeId);
                -1!==index&&(prizes[index]={id:editingPrizeId,emoji,title,description,code,probability})
            }else{
                const newId=0<prizes.length?Math.max(...prizes.map(p=>p.id))+1:1;
                prizes.push({id:newId,emoji,title,description,code,probability})
            }
            savePrizes();
            updatePrizesList();
            updatePrizesStats();
            closePrizeModal()
        }
        
        function deletePrize(id){
            if(!confirm('Supprimer ?'))return;
            prizes=prizes.filter(p=>p.id!==id);
            savePrizes();
            updatePrizesList();
            updatePrizesStats()
        }
        
        function loadConfig(){
            document.getElementById('bookingUrl').value=localStorage.getItem('rocLoveBookingUrl')||'';
            document.getElementById('airbnbUrl').value=localStorage.getItem('rocLoveAirbnbUrl')||'';
            document.getElementById('googleUrl').value=localStorage.getItem('rocLoveGoogleUrl')||''
        }
        
        function saveConfig(){
            const bookingUrl=document.getElementById('bookingUrl').value.trim(),
                  airbnbUrl=document.getElementById('airbnbUrl').value.trim(),
                  googleUrl=document.getElementById('googleUrl').value.trim();
            if((bookingUrl&&!bookingUrl.startsWith('http'))||(airbnbUrl&&!airbnbUrl.startsWith('http'))||(googleUrl&&!googleUrl.startsWith('http'))){
                alert('URL invalide');
                return
            }
            localStorage.setItem('rocLoveBookingUrl',bookingUrl);
            localStorage.setItem('rocLoveAirbnbUrl',airbnbUrl);
            localStorage.setItem('rocLoveGoogleUrl',googleUrl);
            alert('‚úì Sauvegard√© !')
        }
        
        // ‚ùå SUPPRIM√â : Plus de setInterval automatique !
        // ‚úÖ Chargement initial seulement
        window.onload=loadData;
    </script>
    
    <script>
    // ‚úÖ CORRECTION QRCODE - Utilise une API au lieu d'une biblioth√®que bloqu√©e
    let currentQRCodeUrl = null;
    
    window.generateLink = function() {
    const name = document.getElementById('genName').value.trim();
    const phone = document.getElementById('genPhone').value.trim();
    const email = document.getElementById('genEmail').value.trim();
    const channel = document.getElementById('genChannel').value;
    
    if (!name) {
        alert("Merci d'entrer le pr√©nom du client");
        return;
    }
    
    const siteUrl = 'https://gami.rocandlove.fr';
    let link = `${siteUrl}/?n=${encodeURIComponent(name)}`;
    
    if (phone) {
        link += `&t=${encodeURIComponent(phone)}`;
    }
    
    if (email) {
        link += `&e=${encodeURIComponent(email)}`;
    }
    
    link += `&s=${channel}`;
    
    document.getElementById('generatedLink').value = link;
    document.getElementById('generatedResult').classList.remove('hidden');
    
    // G√©n√©rer le QR Code via API
    const qrCodeSize = 256;
    currentQRCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrCodeSize}x${qrCodeSize}&data=${encodeURIComponent(link)}`;
    
    document.getElementById('qrcodeCanvas').innerHTML = `
        <img src="${currentQRCodeUrl}" 
             alt="QR Code" 
             style="border: 4px solid #B9A378; border-radius: 1rem; padding: 1rem; background: #fff; display: block; margin: 0 auto;"
             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22256%22 height=%22256%22><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22>Erreur QR</text></svg>'"
        />
    `;
};
    
    window.downloadQRCode = function() {
        if (!currentQRCodeUrl) {
            alert('‚ö†Ô∏è G√©n√©rez d\'abord un lien');
            return;
        }
        
        const name = document.getElementById('genName').value.trim();
        const link = document.createElement('a');
        link.href = currentQRCodeUrl;
        link.download = `qrcode-${name}.png`;
        link.target = '_blank';
        link.click();
    };
    
    window.printQRCode = function() {
        if (!currentQRCodeUrl) {
            alert('‚ö†Ô∏è G√©n√©rez d\'abord un lien');
            return;
        }
        
        const name = document.getElementById('genName').value.trim();
        const win = window.open('', '_blank');
        win.document.write(`
            <html>
            <head>
                <title>QR Code - ${name}</title>
                <style>
                    body { 
                        text-align: center; 
                        font-family: Georgia, serif;
                        padding: 2rem;
                    }
                    h2 { color: #B9A378; }
                    img { margin: 2rem auto; }
                </style>
            </head>
            <body>
                <h2>Roc & Love - QR Code</h2>
                <p style="font-size: 1.2rem; margin: 1rem;">${name}</p>
                <img src="${currentQRCodeUrl}" alt="QR Code" />
                <p style="font-size: 0.9rem; color: #666;">Scannez ce code pour acc√©der √† votre surprise</p>
            </body>
            </html>
        `);
        win.document.close();
        setTimeout(() => win.print(), 500);
    };
    
    console.log('‚úÖ QR Code corrig√© - Utilise maintenant une API externe');
    </script>
</body>
</html>
