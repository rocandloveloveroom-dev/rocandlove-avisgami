<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Roc &amp; Love - Admin Gamification Avis</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#3b2b2f 0,#050509 55%,#000 100%);color:#f5f5f5;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:20px}
        h1,h2,h3{font-family:"Cormorant Garamond","Times New Roman",serif;letter-spacing:.04em}
        .cormorant{font-family:"Cormorant Garamond","Times New Roman",serif}
        .georgia{font-family:Georgia,"Times New Roman",serif}
        .admin-container{width:100%;max-width:1200px;background:rgba(5,2,8,.95);border-radius:24px;border:1px solid rgba(255,255,255,.08);box-shadow:0 24px 80px rgba(0,0,0,.6);padding:24px 24px 32px;margin:20px auto;backdrop-filter:blur(22px);position:relative;overflow:hidden}
        @media (min-width:768px){.admin-container{padding:32px 40px 40px}}
        .admin-container::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle at 0 0,rgba(185,163,120,.12),transparent 55%),radial-gradient(circle at 100% 100%,rgba(124,92,70,.18),transparent 55%);opacity:.8;z-index:-1}
        .admin-header{display:flex;flex-direction:column;gap:10px;margin-bottom:24px;border-bottom:1px solid rgba(255,255,255,.04);padding-bottom:14px}
        @media (min-width:640px){.admin-header{flex-direction:row;justify-content:space-between;align-items:flex-end}}
        .admin-title-block{display:flex;flex-direction:column;gap:6px}
        .admin-title{font-size:1.9rem;font-weight:600;color:#f9f4ea;text-shadow:0 0 18px rgba(0,0,0,.85)}
        @media (min-width:768px){.admin-title{font-size:2.2rem}}
        .admin-subtitle{font-size:.95rem;color:rgba(244,237,223,.86);max-width:480px;line-height:1.45}
        .admin-badge{align-self:flex-start;padding:6px 12px;border-radius:999px;border:1px solid rgba(185,163,120,.55);background:linear-gradient(135deg,rgba(185,163,120,.18),rgba(79,58,51,.6));color:#f9f4ea;font-size:.8rem;text-transform:uppercase;letter-spacing:.14em;display:inline-flex;align-items:center;gap:8px;backdrop-filter:blur(18px)}
        .admin-badge span{font-size:1rem}
        .admin-grid{display:grid;grid-template-columns:1.4fr 1fr;gap:20px}
        @media (max-width:1023px){.admin-grid{grid-template-columns:1fr}}
        .card{background:radial-gradient(circle at top,rgba(29,21,32,.95),rgba(9,6,11,.98));border-radius:20px;border:1px solid rgba(255,255,255,.06);padding:18px 18px 20px;box-shadow:0 18px 50px rgba(0,0,0,.75);position:relative;overflow:hidden}
        @media (min-width:768px){.card{padding:22px 20px 22px}}
        .card::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle at 0 0,rgba(185,163,120,.16),transparent 55%);opacity:.4;z-index:-1}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .card-title{font-size:1.4rem;font-weight:600;color:#f9f3e8}
        .card-kicker{font-size:.8rem;text-transform:uppercase;letter-spacing:.18em;color:rgba(248,239,224,.75)}
        .divider{width:100%;height:1px;background:linear-gradient(90deg,rgba(185,163,120,0),rgba(185,163,120,.55),rgba(185,163,120,0));margin:12px 0 16px}
        label{display:block;margin-bottom:6px;font-size:.9rem;color:rgba(244,237,223,.85)}
        .input-field,.select-field{width:100%;padding:10px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.09);background:rgba(7,4,10,.9);color:#f7f2e7;font-size:.9rem;outline:0;transition:border-color .18s ease,box-shadow .18s ease,transform .12s ease}
        .input-field:focus,.select-field:focus{border-color:rgba(185,163,120,.85);box-shadow:0 0 0 1px rgba(185,163,120,.6);transform:translateY(-1px)}
        .input-field::placeholder{color:rgba(236,226,210,.5)}
        .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:999px;padding:9px 18px;font-size:.9rem;font-weight:600;cursor:pointer;border:0;transition:transform .12s ease,box-shadow .12s ease,filter .12s ease;white-space:nowrap}
        .btn-primary{background:linear-gradient(135deg,#b9a378,#8b7355);color:#1a1410;box-shadow:0 12px 30px rgba(0,0,0,.7)}
        .btn-primary:hover{transform:translateY(-1px);box-shadow:0 16px 40px rgba(0,0,0,.85);filter:brightness(1.05)}
        .btn-ghost{border-radius:999px;border:1px solid rgba(255,255,255,.12);background:radial-gradient(circle at top,rgba(255,255,255,.06),rgba(7,4,10,.95));color:#f4ede1}
        .btn-ghost:hover{border-color:rgba(255,255,255,.25);background:radial-gradient(circle at top,rgba(255,255,255,.12),rgba(10,6,13,.98))}
        .btn-small{padding:6px 12px;font-size:.8rem}
        .btn-icon{display:inline-flex;align-items:center;gap:8px}
        .btn-icon span:first-child{font-size:1rem}
        .grid{display:grid;gap:10px}
        .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
        @media (max-width:640px){.grid-2{grid-template-columns:1fr}}
        .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:.75rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);gap:6px}
        .pill-dot{width:7px;height:7px;border-radius:999px;background:radial-gradient(circle,#e6c79c,#b28a5b)}
        .textarea{width:100%;min-height:80px;border-radius:14px;border:1px solid rgba(255,255,255,.09);background:rgba(7,4,10,.9);color:#f7f2e7;font-size:.9rem;padding:10px 12px;resize:vertical;outline:0}
        .textarea:focus{border-color:rgba(185,163,120,.85);box-shadow:0 0 0 1px rgba(185,163,120,.6)}
        .table-wrapper{margin-top:10px;border-radius:16px;border:1px solid rgba(255,255,255,.06);background:radial-gradient(circle at top,rgba(19,13,23,.98),rgba(6,4,9,.98));overflow:hidden}
        table{width:100%;border-collapse:collapse;font-size:.82rem}
        th,td{padding:9px 10px;text-align:left}
        thead{background:linear-gradient(90deg,rgba(185,163,120,.09),rgba(185,163,120,.03))}
        th{font-weight:500;color:rgba(249,241,229,.9);border-bottom:1px solid rgba(255,255,255,.08);white-space:nowrap}
        tbody tr:nth-child(even){background:rgba(255,255,255,.01)}
        tbody tr:hover{background:rgba(185,163,120,.06)}
        td{border-bottom:1px solid rgba(255,255,255,.04);color:rgba(245,237,225,.9)}
        .tag{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;border:1px solid rgba(185,163,120,.7);color:#f1e3cf;background:radial-gradient(circle at top,rgba(185,163,120,.3),rgba(46,32,28,.95));font-size:.72rem}
        .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:radial-gradient(circle,#7bdcb5,#00a86b);margin-right:6px}
        .helper-text{font-size:.78rem;color:rgba(238,227,209,.75);margin-top:4px}
        .highlight{color:#f4d4a4;font-weight:500}
        .footer-note{margin-top:18px;font-size:.78rem;color:rgba(237,225,207,.8);display:flex;align-items:center;gap:6px}
        .footer-note span{font-size:1rem}
        .badge-soft{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:.78rem;background:rgba(185,163,120,.12);border:1px solid rgba(185,163,120,.45);color:#f7ecd6;gap:8px}
        .badge-soft span{font-size:.9rem}
        .qrcode-box{margin:14px auto 0;padding:14px;border-radius:18px;border:1px dashed rgba(185,163,120,.7);background:radial-gradient(circle at top,rgba(255,255,255,.04),rgba(9,6,11,.98))}
        .qrcode-box p{font-size:.82rem;color:rgba(238,227,209,.85);margin-bottom:10px;text-align:center}
        .qrcode-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
        .qrcode-canvas-wrapper{display:flex;justify-content:center;margin-top:10px}
        .pill-sub{font-size:.75rem;color:rgba(233,220,200,.85)}
        .pill-sub strong{color:#f6d9a8}
        .input-small{width:60px}
        .results-note{font-size:.86rem;color:rgba(240,229,212,.88);margin-bottom:6px;display:flex;align-items:center;gap:8px}
        .results-note span{font-size:1rem}
        .results-note strong{color:#f6d3a4;font-weight:600}
        .toggle-link{font-size:.8rem;color:rgba(244,224,191,.9);cursor:pointer;text-decoration:underline;text-decoration-style:dotted}
        .qrcode-visual-note{font-size:.76rem;color:rgba(233,222,206,.8);margin-top:6px;text-align:center}
        @media (max-width:480px){
            .admin-title{font-size:1.7rem}
            .card{padding:16px 14px 18px}
            .admin-container{padding:18px 16px 26px}
        }
        .input-field[disabled]{opacity:.8;cursor:not-allowed;background:rgba(20,16,24,.85)}
        .glow-ring{position:absolute;inset:-1px;border-radius:24px;border:1px solid transparent;background:linear-gradient(135deg,rgba(185,163,120,.35),rgba(68,52,66,.8)) border-box;mask:linear-gradient(#000 0 0) padding-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.18;pointer-events:none}
        .badge-env{display:inline-flex;align-items:center;padding:4px 9px;border-radius:999px;font-size:.75rem;background:rgba(29,78,216,.18);border:1px solid rgba(59,130,246,.7);color:#dbeafe;gap:6px}
        .badge-env span{font-size:.9rem}
        .admin-meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
        .admin-meta-right{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
        @media (min-width:640px){.admin-meta-right{align-items:flex-end}}
    </style>
</head>
<body>
<div class="admin-container">
    <div class="glow-ring"></div>
    
    <header class="admin-header">
        <div class="admin-title-block">
            <div class="card-kicker georgia">Dashboard priv√© ¬∑ GamiAvis</div>
            <h1 class="admin-title cormorant">Roc &amp; Love ¬∑ Panneau d'administration</h1>
            <p class="admin-subtitle georgia">
                Centralise les avis, pilote les r√©compenses et g√©n√®re des liens/QR codes track√©s pour chaque client. 
                <span class="highlight">Objectif&nbsp;: booster les avis 5‚òÖ tout en restant ultra fluide pour toi.</span>
            </p>
        </div>
        <div class="admin-meta">
            <div class="admin-meta-right">
                <div class="admin-badge">
                    <span>‚ú®</span>
                    <span>Version b√™ta priv√©e</span>
                </div>
                <div class="badge-soft">
                    <span>üß©</span>
                    <span>Admin local ¬∑ Navigateur seulement</span>
                </div>
            </div>
        </div>
    </header>

    <div class="admin-grid">
        <section class="card">
            <div class="card-header">
                <div>
                    <h2 class="card-title cormorant">G√©n√©rateur de lien &amp; QR Code</h2>
                    <p class="pill-sub">
                        <span class="status-dot"></span>
                        <strong>√âtape 1 :</strong> cr√©e un lien unique √† envoyer au client selon sa plateforme de r√©servation.
                    </p>
                </div>
            </div>
            <div class="divider"></div>
            
            <div class="grid grid-2">
                <div>
                    <label class="georgia text-sm text-gray-400 mb-2 block">Pr√©nom du client</label>
                    <input type="text" id="genName" class="input-field" placeholder="Marie">
                </div>
                <div>
                    <label class="georgia text-sm text-gray-400 mb-2 block">T√©l√©phone (optionnel)</label>
                    <input type="tel" id="genPhone" class="input-field" placeholder="0612345678">
                </div>
                <div>
                    <label class="georgia text-sm text-gray-400 mb-2 block">Email du client</label>
                    <input type="text" id="genEmail" class="input-field" placeholder="client@exemple.com">
                </div>
                <div>
                    <label class="georgia text-sm text-gray-400 mb-2 block">Plateforme de r√©servation</label>
                    <select id="genChannel" class="input-field">
                        <option value="direct">‚≠ê Direct (Google)</option>
                        <option value="booking">üè® Booking.com</option>
                        <option value="airbnb">üè† Airbnb</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
                <button onclick="generateLink()" class="btn btn-primary btn-icon cormorant" style="font-size:1rem;padding:10px 18px">
                    <span>ü™Ñ</span><span>G√©n√©rer le lien &amp; le QR Code</span>
                </button>
                <div class="helper-text">
                    Le lien inclura automatiquement <span class="highlight">n</span> (pr√©nom), 
                    <span class="highlight">t</span> (t√©l√©phone), 
                    <span class="highlight">e</span> (email)
                    et <span class="highlight">s</span> (source).
                </div>
            </div>

            <div id="generatedResult" style="margin-top:16px;display:none">
                <div class="results-note">
                    <span>üîó</span>
                    <div>Voici le lien personnalis√© du client &nbsp;‚Üí&nbsp; <strong>pr√™t √† copier/coller</strong>.</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
                    <input type="text" id="generatedLink" class="input-field" readonly>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
                        <button type="button" onclick="copyGeneratedLink()" class="btn btn-ghost btn-small btn-icon">
                            <span>üìã</span><span>Copier le lien</span>
                        </button>
                        <span class="helper-text">Colle-le dans ton message WhatsApp, SMS, ou email selon le canal choisi.</span>
                    </div>
                </div>

                <div class="qrcode-box">
                    <p>QR Code pr√™t √† √™tre scann√© (utile pour les supports imprim√©s, tablette √† Roc &amp; Love, etc.).</p>
                    <div id="qrcodeCanvas" class="qrcode-canvas-wrapper"></div>
                    <div class="qrcode-actions">
                        <button type="button" onclick="downloadQRCode()" class="btn btn-ghost btn-small btn-icon">
                            <span>‚¨áÔ∏è</span><span>T√©l√©charger le QR</span>
                        </button>
                        <button type="button" onclick="printQRCode()" class="btn btn-ghost btn-small btn-icon">
                            <span>üñ®Ô∏è</span><span>Imprimer le QR</span>
                        </button>
                    </div>
                    <p class="qrcode-visual-note">
                        Tu peux afficher ce QR sur une tablette ou le glisser dans un visuel Canva pour tes supports.
                    </p>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <div>
                    <h2 class="card-title cormorant">Param√®tres des r√©compenses</h2>
                    <p class="pill-sub">
                        <span class="status-dot"></span>
                        <strong>√âtape 2 :</strong> configure les cadeaux associ√©s aux paliers d'avis.
                    </p>
                </div>
            </div>
            <div class="divider"></div>

            <div class="grid" style="gap:12px">
                <div class="pill">
                    <span class="pill-dot"></span>
                    <span>Gestion locale (stock√©e dans ton navigateur uniquement)</span>
                </div>
                <p class="helper-text">
                    Ces r√©glages ne partent pas en ligne : ils sont m√©moris√©s dans le <span class="highlight">localStorage</span> de ton navigateur.
                    Si tu changes d'ordinateur ou de navigateur, pense √† les reconfigurer.
                </p>

                <div class="grid grid-2" style="margin-top:8px">
                    <div>
                        <label>Palier 1 ¬∑ Avis 5‚òÖ direct (Google)</label>
                        <input type="text" id="prizeDirect" class="input-field" placeholder="ex : 1 Love Box d√©gustation offerte">
                    </div>
                    <div>
                        <label>Palier 2 ¬∑ Avis 5‚òÖ plateforme (Booking/Airbnb)</label>
                        <input type="text" id="prizePlatform" class="input-field" placeholder="ex : 1 surclassement / surprise d√©co">
                    </div>
                    <div>
                        <label>Palier 3 ¬∑ Challenge combin√© (Google + plateforme)</label>
                        <input type="text" id="prizeCombo" class="input-field" placeholder="ex : 1 nuit Love Room √† -50%">
                    </div>
                    <div>
                        <label>Texte d'intro (optionnel)</label>
                        <textarea id="introText" class="textarea" placeholder="ex : Merci pour votre s√©jour √† Roc &amp; Love ! On a une petite surprise si vous nous laissez un avis..."></textarea>
                    </div>
                </div>

                <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px">
                    <button type="button" onclick="savePrizes()" class="btn btn-primary btn-small btn-icon">
                        <span>üíæ</span><span>Enregistrer les r√©compenses</span>
                    </button>
                    <span class="helper-text">Tu peux adapter les cadeaux au fil du temps (saison, remplissage, budget...).</span>
                </div>
            </div>
        </section>
    </div>

    <section class="card" style="margin-top:20px">
        <div class="card-header">
            <div>
                <h2 class="card-title cormorant">Suivi des participations &amp; exports</h2>
                <p class="pill-sub">
                    <span class="status-dot"></span>
                    <strong>√âtape 3 :</strong> visualise les participations et g√©n√®re un export manuel.
                </p>
            </div>
        </div>
        <div class="divider"></div>

        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px">
            <button type="button" onclick="loadAdminData()" class="btn btn-primary btn-small btn-icon">
                <span>üîÑ</span><span>Charger / Rafra√Æchir les participations</span>
            </button>
            <button type="button" onclick="exportToCSV()" class="btn btn-ghost btn-small btn-icon">
                <span>üì§</span><span>Exporter en CSV</span>
            </button>
            <span class="helper-text">
                Rafra√Æchis apr√®s une vague d'avis pour voir les nouvelles participations r√©cup√©r√©es via ton endpoint.
            </span>
        </div>

        <p class="helper-text" style="margin-bottom:8px">
            Les donn√©es ci-dessous sont r√©cup√©r√©es depuis ton API (endpoint d'administration). 
            <span class="highlight">Aucune donn√©e n'est envoy√©e √† un outil tiers depuis cette page.</span>
        </p>

        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Source</th>
                    <th>Code</th>
                    <th>Date</th>
                    <th>Statut</th>
                </tr>
                </thead>
                <tbody id="adminTableBody">
                <tr>
                    <td colspan="6" style="text-align:center;color:rgba(233,222,206,.8);padding:14px">
                        Aucune donn√©e charg√©e pour l'instant. Clique sur <span class="highlight">‚ÄúCharger / Rafra√Æchir les participations‚Äù</span>.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="footer-note">
            <span>üß†</span>
            <div>
                Astuce&nbsp;: √† terme, tu pourras relier ces exports √† un Google Sheet ou √† ton CRM pour suivre la 
                <span class="highlight">valeur √† vie de chaque client (LTV)</span> selon ses avis laiss√©s.
            </div>
        </div>
    </section>
</div>

<script>
    let prizes = {
        direct:"",
        platform:"",
        combo:"",
        intro:""
    };

    let adminData = [];

    function loadPrizes(){
        const stored = localStorage.getItem('rocLovePrizes');
        if(stored){
            try{
                prizes = JSON.parse(stored);
                document.getElementById('prizeDirect').value = prizes.direct || "";
                document.getElementById('prizePlatform').value = prizes.platform || "";
                document.getElementById('prizeCombo').value = prizes.combo || "";
                document.getElementById('introText').value = prizes.intro || "";
            }catch(e){
                console.error("Erreur de parsing des r√©compenses:", e);
            }
        }
    }

    function savePrizes(){
        prizes.direct = document.getElementById('prizeDirect').value.trim();
        prizes.platform = document.getElementById('prizePlatform').value.trim();
        prizes.combo = document.getElementById('prizeCombo').value.trim();
        prizes.intro = document.getElementById('introText').value.trim();
        localStorage.setItem('rocLovePrizes', JSON.stringify(prizes));
        alert("R√©compenses enregistr√©es localement (dans ce navigateur).");
    }

    function copyGeneratedLink(){
        const link = document.getElementById('generatedLink').value;
        navigator.clipboard.writeText(link);
        alert("Lien copi√© dans le presse-papiers.");
    }

    async function loadAdminData(){
        try{
            const response = await fetch('/api/admin-data');
            if(!response.ok){
                throw new Error("Erreur lors du chargement des donn√©es admin");
            }
            adminData = await response.json();
            renderAdminTable();
        }catch(error){
            console.error("Erreur API:", error);
            adminData = [];
            renderAdminTable(true);
        }
    }

    function renderAdminTable(isError){
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = "";

        if(isError){
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 6;
            td.style.textAlign = "center";
            td.style.color = "rgba(233,222,206,.85)";
            td.style.padding = "14px";
            td.textContent = "Impossible de charger les donn√©es (v√©rifie l'API /api/admin-data).";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        if(!adminData || adminData.length === 0){
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 6;
            td.style.textAlign = "center";
            td.style.color = "rgba(233,222,206,.85)";
            td.style.padding = "14px";
            td.textContent = "Aucune participation enregistr√©e pour le moment.";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        adminData.forEach(entry => {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = entry.name || "-";

            const tdContact = document.createElement('td');
            const phone = entry.phone || "";
            const email = entry.email || "";
            tdContact.textContent = [phone, email].filter(Boolean).join(" / ") || "-";

            const tdSource = document.createElement('td');
            tdSource.textContent = entry.source || "-";

            const tdCode = document.createElement('td');
            tdCode.textContent = entry.code || "-";

            const tdDate = document.createElement('td');
            tdDate.textContent = entry.date || "-";

            const tdStatus = document.createElement('td');
            const statusSpan = document.createElement('span');
            statusSpan.className = "tag";
            statusSpan.textContent = entry.status || "√Ä v√©rifier";
            tdStatus.appendChild(statusSpan);

            tr.appendChild(tdName);
            tr.appendChild(tdContact);
            tr.appendChild(tdSource);
            tr.appendChild(tdCode);
            tr.appendChild(tdDate);
            tr.appendChild(tdStatus);

            tbody.appendChild(tr);
        });
    }

    function exportToCSV(){
        if(!adminData || adminData.length === 0){
            alert("Aucune donn√©e √† exporter. Commence par charger les participations.");
            return;
        }

        const headers = ["Nom", "T√©l√©phone", "Email", "Source", "Code", "Date", "Statut"];
        const rows = adminData.map(entry => [
            entry.name || "",
            entry.phone || "",
            entry.email || "",
            entry.source || "",
            entry.code || "",
            entry.date || "",
            entry.status || ""
        ]);

        let csvContent = "data:text/csv;charset=utf-8," 
            + headers.join(";") + "\n"
            + rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(";")).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "rocandlove_participations.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function loadData(){
        loadPrizes();
    }

    window.onload = loadData;
</script>

<script>
    // ‚úÖ CORRECTION QRCODE - Utilise une API au lieu d'une biblioth√®que bloqu√©e
    let currentQRCodeUrl = null;

    window.generateLink = function() {
        const name = document.getElementById('genName').value.trim();
        const phone = document.getElementById('genPhone').value.trim();
        const email = document.getElementById('genEmail').value.trim();
        const channel = document.getElementById('genChannel').value;

        if (!name) {
            alert("Merci d'entrer le pr√©nom du client");
            return;
        }

        const siteUrl = 'https://gami.rocandlove.fr';
        let link = `${siteUrl}/?n=${encodeURIComponent(name)}`;

        if (phone) {
            link += `&t=${encodeURIComponent(phone)}`;
        }

        if (email) {
            link += `&e=${encodeURIComponent(email)}`;
        }

        link += `&s=${channel}`;

        document.getElementById('generatedLink').value = link;
        document.getElementById('generatedResult').style.display = 'block';

        // G√©n√©rer le QR Code via API
        const qrCodeSize = 256;
        currentQRCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrCodeSize}x${qrCodeSize}&data=${encodeURIComponent(link)}`;

        document.getElementById('qrcodeCanvas').innerHTML = `
        <img src="${currentQRCodeUrl}" 
             alt="QR Code" 
             style="border: 4px solid #B9A378; border-radius: 1rem; padding: 1rem; background: #fff; display: block; margin: 0 auto;"
             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22256%22 height=%22256%22><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22>Erreur QR</text></svg>'"
        />
    `;
    };

    window.downloadQRCode = function() {
        if (!currentQRCodeUrl) {
            alert("Aucun QR Code √† t√©l√©charger. G√©n√®re d'abord un lien.");
            return;
        }
        const link = document.createElement('a');
        link.href = currentQRCodeUrl;
        link.download = 'rocandlove_qrcode.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    window.printQRCode = function() {
        if (!currentQRCodeUrl) {
            alert("Aucun QR Code √† imprimer. G√©n√®re d'abord un lien.");
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
        <html>
            <head>
                <title>Impression QR Code Roc & Love</title>
            </head>
            <body style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f7f1e8;">
                <div style="text-align:center;">
                    <h2 style="font-family:Georgia,serif;margin-bottom:16px;color:#4a3728;">QR Code Roc & Love</h2>
                    <img src="${currentQRCodeUrl}" alt="QR Code" style="border:4px solid #B9A378;border-radius:16px;padding:12px;background:#fff;"/>
                    <p style="margin-top:12px;font-family:Arial, sans-serif;color:#5c4635;">Scannez ce QR Code pour laisser un avis apr√®s votre s√©jour.</p>
                </div>
            </body>
        </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    };
</script>
</body>
</html>
